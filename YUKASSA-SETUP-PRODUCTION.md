# üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa –¥–ª—è PRODUCTION

## ‚úÖ –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ÆKassa

- **Shop ID:** `1140593`
- **Secret Key:** `live_B289hcXcdYNXYHGuWuIukWeQCp2CCqAfhF_WMpyvHQQ`
- **–†–µ–∂–∏–º:** PRODUCTION (live)

---

## üìã –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### 1.1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:
```bash
ssh root@5741777-jh90179
cd /opt/alim-kitabhane
```

### 1.2. –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `.env`:
```bash
nano .env
```

### 1.3. –î–æ–±–∞–≤—å—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏:
```env
# –ÆKassa –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (PRODUCTION)
YUKASSA_SHOP_ID=1140593
YUKASSA_SECRET_KEY=live_B289hcXcdYNXYHGuWuIukWeQCp2CCqAfhF_WMpyvHQQ

# JWT —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (—Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π!)
JWT_SECRET=alim-kitaphane-super-secret-jwt-key-2024-production

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
PORT=3000
NODE_ENV=production

# URL —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è CORS
FRONTEND_URL=https://alimkitaphane.ru

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
DB_TYPE=sqlite
DB_PATH=./database/krym_chitalka.db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∞–π–ª–æ–≤
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: `Ctrl+X`, –∑–∞—Ç–µ–º `Y`, –∑–∞—Ç–µ–º `Enter`

### 1.4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
docker compose restart app
```

---

## üìã –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

### 2.1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa:
https://yookassa.ru/my

### 2.2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª:
**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞** ‚Üí **HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**

### 2.3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Webhook:

**URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
```
https://alimkitaphane.ru/api/payments/webhook
```

**–°–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- ‚úÖ `payment.succeeded` (–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω)
- ‚úÖ `payment.canceled` (–ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω)

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:** `JSON`

### 2.4. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"

---

## üìã –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3.1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
docker compose ps
docker compose logs app --tail 50
```

### 3.2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API:
```bash
curl -I https://alimkitaphane.ru/api/payments/webhook
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: `405 Method Not Allowed` (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–∞)

### 3.3. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
https://alimkitaphane.ru
```

### 3.4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–∫—É–ø–∫—É:
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç–µ
2. –ù–∞–∂–º–∏—Ç–µ "–ö—É–ø–∏—Ç—å –∏ —á–∏—Ç–∞—Ç—å"
3. –°–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏
4. –ù–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –ÆKassa"

–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa.

### 3.5. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç –≤ live —Ä–µ–∂–∏–º–µ):

**‚úÖ –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
- –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: `5555 5555 5555 4477`
- –°—Ä–æ–∫: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `12/25`)
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `123`)

**‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂:**
- –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: `5555 5555 5555 5599`
- –°—Ä–æ–∫: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã

---

## üìã –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 4.1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏:
```bash
docker compose logs app | grep -i payment
docker compose logs app | grep -i yukassa
```

### 4.2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:
https://yookassa.ru/my/payments

### 4.3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–Ω–∏–≥–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ:
- –í–æ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç
- –û—Ç–∫—Ä–æ–π—Ç–µ "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"
- –ö–Ω–∏–≥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞"

---

## ‚ö†Ô∏è –í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
1. ‚ùó **–ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ** —Ñ–∞–π–ª `.env` –≤ git
2. ‚ùó **–ù–ï –¥–µ–ª–∏—Ç–µ—Å—å** Secret Key —Å –∫–µ–º-–ª–∏–±–æ
3. ‚úÖ –§–∞–π–ª `.env` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`

### –ö–æ–º–∏—Å—Å–∏—è –ÆKassa:
- –ö–æ–º–∏—Å—Å–∏—è –¥–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö: **3.6% + 0‚ÇΩ** –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
- –î–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ —Å—á–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π

### –õ–∏–º–∏—Ç—ã:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: **10‚ÇΩ**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: **100,000‚ÇΩ**

---

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ "Invalid credentials":
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:
docker compose exec app printenv | grep YUKASSA
```

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
docker compose logs app | grep webhook
```

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç:
```bash
sudo ufw status | grep 443
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ nginx:
```bash
docker compose logs nginx
```

### –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `payment.succeeded` –≤–∫–ª—é—á–µ–Ω –≤ —Å–æ–±—ã—Ç–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook:
```bash
docker compose logs app | grep "payment.succeeded"
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ÆKassa

- **–¢–µ–ª–µ—Ñ–æ–Ω:** 8 (800) 250-66-99
- **Email:** support@yookassa.ru
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://yookassa.ru/developers

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- ‚úÖ –ü–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ PRODUCTION —Ä–µ–∂–∏–º–µ
- ‚úÖ –î–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ –≤–∞—à —Å—á–µ—Ç
- ‚úÖ Webhook —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–Ω–∏–≥–∞–º –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

**–ù–∞—á–∏–Ω–∞–π—Ç–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏! üéâ**
