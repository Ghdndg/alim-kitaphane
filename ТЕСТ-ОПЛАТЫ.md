# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa

## ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:
- ‚úÖ Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ Backend —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ –ÆKassa
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç
- ‚úÖ Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
- ‚úÖ –ö–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üîç –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### 1.1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
ssh root@5741777-jh90179
cd /opt/alim-kitabhane

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–ª—é—á–∏ –ÆKassa –∑–∞–≥—Ä—É–∂–µ–Ω—ã
docker compose exec app printenv | grep YUKASSA
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
YUKASSA_SHOP_ID=1140593
YUKASSA_SECRET_KEY=live_B289hcXcdYNXYHGuWuIukWeQCp2CCqAfhF_WMpyvHQQ
```

### 1.2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```bash
docker compose logs app --tail 50
```

–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ –∑–∞–ø—É—Å–∫–∞.

### 1.3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 200 –∏–ª–∏ 401 (Unauthorized - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞)
curl -I https://alimkitaphane.ru/api/books
```

---

## üß™ –®–∞–≥ 2: –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞

### 2.1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç:
```
https://alimkitaphane.ru
```

### 2.2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ:
- –ù–∞–∂–º–∏—Ç–µ "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"
- –í–≤–µ–¥–∏—Ç–µ –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ:
  - –ò–º—è: `–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤`
  - Email: `test@test.ru`
  - –ü–∞—Ä–æ–ª—å: `test123`

### 2.3. –ù–∞–∂–º–∏—Ç–µ "–ö—É–ø–∏—Ç—å –∏ —á–∏—Ç–∞—Ç—å"

### 2.4. –í –æ–∫–Ω–µ –æ–ø–ª–∞—Ç—ã:
- ‚úÖ –ü–æ—Å—Ç–∞–≤—å—Ç–µ –≥–∞–ª–æ—á–∫—É "–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º"
- –ù–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –ÆKassa 299 ‚ÇΩ"

### 2.5. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ÆKassa

### 2.6. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É:

**‚úÖ –î–ª—è —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:**
- **–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:** `5555 5555 5555 4477`
- **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:** `12/25` (–ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞)
- **CVC:** `123` (–ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã)
- **–î–µ—Ä–∂–∞—Ç–µ–ª—å:** `TEST CARD`

**‚ùå –î–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã:**
- **–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:** `5555 5555 5555 5599`
- **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:** `12/25`
- **CVC:** `123`

### 2.7. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:
- –í—ã –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –Ω–∞ `https://alimkitaphane.ru/payment-success.html`
- –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å "–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!"
- –ö–Ω–∏–≥–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" ‚Üí "–ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞"

---

## üîç –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### 3.1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker compose logs app | grep -A 5 "Create payment"
```

### 3.2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook:
```bash
docker compose logs app | grep -A 10 "payment.succeeded"
```

### 3.3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx:
```bash
docker compose logs nginx | grep "/api/payments"
```

---

## ‚ùå –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –û—à–∏–±–∫–∞: "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"
**–ü—Ä–∏—á–∏–Ω–∞:** bookId –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–Ω–∏–≥–∞ —Å ID=1 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ:
```bash
docker compose exec app node -e "const {pool} = require('./config/database'); pool.query('SELECT * FROM books WHERE id=1').then(r => console.log(r.rows))"
```

2. –ï—Å–ª–∏ –∫–Ω–∏–≥–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤—å—Ç–µ –µ—ë —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É –∏–ª–∏ SQL

### –û—à–∏–±–∫–∞: "Unauthorized"
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12 ‚Üí Application ‚Üí Local Storage):
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å `accessToken`
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å `currentUser`

### –û—à–∏–±–∫–∞: "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–ª—é—á–∞–º–∏ –ÆKassa

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ –≤ `.env`:
```bash
cat .env | grep YUKASSA
```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
docker compose restart app
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ÆKassa:
```bash
docker compose logs app | grep "–ÆKassa error"
```

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

**–†–µ—à–µ–Ω–∏–µ:**
1. –í–æ–π–¥–∏—Ç–µ –≤ https://yookassa.ru/my
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞ ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. URL: `https://alimkitaphane.ru/api/payments/webhook`
4. –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

1. –í–æ–π–¥–∏—Ç–µ –≤ https://yookassa.ru/my/payments
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:
   - **succeeded** - –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞
   - **pending** - –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
   - **canceled** - –æ—Ç–º–µ–Ω–µ–Ω

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –ø–ª–∞—Ç–µ–∂–µ–π:
```bash
docker compose exec app node -e "const {pool} = require('./config/database'); pool.query('SELECT * FROM purchases ORDER BY created_at DESC LIMIT 5').then(r => console.log(JSON.stringify(r.rows, null, 2)))"
```

### –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏:
```bash
docker compose exec app node -e "const {pool} = require('./config/database'); pool.query('DELETE FROM purchases WHERE user_id IN (SELECT id FROM users WHERE email LIKE \\'test%\\')').then(() => console.log('Cleared'))"
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```bash
docker compose exec app node -e "const {pool} = require('./config/database'); pool.query('SELECT u.email, b.title, p.status, p.amount FROM purchases p JOIN users u ON p.user_id=u.id JOIN books b ON p.book_id=b.id').then(r => console.log(JSON.stringify(r.rows, null, 2)))"
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ï—Å–ª–∏ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:
- ‚úÖ –ü–ª–∞—Ç–µ–∂–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –ÆKassa
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π
- ‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∫–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
- ‚úÖ Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏
- ‚úÖ –î–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ –≤–∞—à —Å—á–µ—Ç

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ**
